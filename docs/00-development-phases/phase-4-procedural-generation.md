# Phase 4: Deterministic Procedural Generation

**Version:** 1.5 **Date:** 2025-11-13

## Goal
Create the "infinite" level, generated by the server and sent to clients.

## Tasks

* Implement the **Seeded PRNG** logic on the server.
* Implement the **Level Chunk** generation logic (e.g., `generateChunk(seed)`).
* Define the `{"e": "chunk", ...}` network message.
* The server now generates chunks ahead of the players and broadcasts them.
* The server's collision detection now uses the procedurally generated obstacle data.
* The client receives chunk data and renders the obstacles.

## Assets Required

### Obstacle Library (SVG/PNG)
* `obstacle-glitch-tall.svg` (A tall, thin "firewall").
* `obstacle-glitch-low.svg` (A low, wide "data-block").
* `obstacle-glitch-spike.svg` (A small "glitch" to jump over).

### Collectible Library (SVG/PNG)
* `collectible-snippet-01.svg` (e.g., glowing `<blink>`).
* `collectible-snippet-02.svg` (e.g., glowing `goto 10;`).

*Note: This phase requires a small library of assets for the PRNG to choose from. Refer to docs/03-art-style-aesthetics.md Section 3.5 for visual style.*

## Success Criteria

- Server generates master seed on startup
- Level chunks generate deterministically from seed
- Same seed produces identical obstacle layouts
- Server generates chunks ahead of player position
- Chunk data broadcasts to clients before players reach them
- Clients receive and parse chunk messages
- Clients render obstacles from chunk data
- Server collision detection uses procedural obstacle positions
- All connected players see identical obstacle layouts
- Level extends infinitely as players progress

## Technical Notes

**Deterministic Generation Algorithm:**
```
1. Server starts with masterSeed = "vibe-runner-12345"
2. For chunk N, calculate: seed_N = hash(masterSeed + N)
3. Initialize PRNG with seed_N
4. Generate obstacles using PRNG:
   - Choose obstacle type (1-3)
   - Choose X position within chunk bounds
   - Choose Y position (ground level or elevated)
5. Broadcast chunk data to all clients
```

**Chunk Management:**
- Chunk size: ~5 screen widths (e.g., 5000 pixels)
- Generate chunks when leading player is within 2 screen widths
- Keep last N chunks in memory for collision detection
- Garbage collect old chunks behind all players

**Message Format:**
```json
{
  "e": "chunk",
  "d": {
    "id": 10,
    "obs": [
      {"t": 1, "x": 15000, "y": 0},
      {"t": 2, "x": 15100, "y": 0}
    ]
  }
}
```

Refer to docs/04-technical-architecture/backend-go.md for detailed procedural generation implementation.
